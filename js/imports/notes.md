–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è
‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: –ë–î –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç—Å—è (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ INSERT-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
üî¥ –ß—Ç–æ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è?
–ï—Å–ª–∏ —É —Ç–µ–±—è –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –º–ª–Ω —Å—Ç—Ä–æ–∫), –∫–æ–¥ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ –ë–î —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ, –∏ —Å–µ—Ä–≤–µ—Ä PostgreSQL –º–æ–∂–µ—Ç –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è.

‚úÖ –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?
–ò—Å–ø–æ–ª—å–∑—É–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ p-map –∏–ª–∏ Batch INSERT.

üìå –†–µ—à–µ–Ω–∏–µ 1: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∏—Å–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (p-map)
js
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const pMap = require('p-map');

const transformStream = new Transform({
objectMode: true,
async transform(row, encoding, callback) {
row.name = row.name.toUpperCase();

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ë–î
    await pMap(
      [row], // –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö (–∑–¥–µ—Å—å –ø–æ 1 —Å—Ç—Ä–æ–∫–µ)
      async (item) => {
        await db.query('INSERT INTO users (name, email) VALUES ($1, $2)', [item.name, item.email]);
      },
      { concurrency: 10 } // –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–µ –±–æ–ª—å—à–µ 10 –∑–∞–ø–∏—Å–µ–π
    );

    callback(null, row);
}
});
üëâ –¢–µ–ø–µ—Ä—å –≤ –ë–î –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∏—à–µ—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ 10 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç—Å—è.

üìå –†–µ—à–µ–Ω–∏–µ 2: Batch INSERT (–í—Å—Ç–∞–≤–∫–∞ –ø–∞—á–∫–∞–º–∏)
js
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const batchSize = 1000;
let buffer = [];

const transformStream = new Transform({
objectMode: true,
async transform(row, encoding, callback) {
row.name = row.name.toUpperCase();
buffer.push(row);

    if (buffer.length >= batchSize) {
      await insertBatch(); // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–∞—á–∫—É –≤ –ë–î
    }

    callback(null, row);
}
});

async function insertBatch() {
if (buffer.length === 0) return;

const values = buffer.map(row => `('${row.name}', '${row.email}')`).join(',');
await db.query(`INSERT INTO users (name, email) VALUES ${values}`);

buffer = []; // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
}
üëâ –¢–µ–ø–µ—Ä—å –º—ã –≤—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—á–∫–∞–º–∏ –ø–æ 1000 —Å—Ç—Ä–æ–∫ –≤–º–µ—Å—Ç–æ 1 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É ‚Äî —ç—Ç–æ —Å–∏–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –∏–º–ø–æ—Ä—Ç.

‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Ä–∞–Ω—å—à–µ, —á–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å
üî¥ –ß—Ç–æ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è?
–ö–æ–¥ .on('finish', () => db.end()) –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞, –Ω–æ –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.

‚úÖ –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?
–ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è, –ø—Ä–µ–∂–¥–µ —á–µ–º –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:

js
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
const { finished } = require('stream/promises');

(async () => {
const stream = fs.createReadStream('data.csv')
.pipe(csv())
.pipe(transformStream);

await finished(stream); // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
await insertBatch(); // –í—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ
await db.end(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
console.log('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');
})();
üëâ –¢–µ–ø–µ—Ä—å –ë–î –∑–∞–∫—Ä–æ–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

üîπ –ò—Ç–æ–≥: –±—É–¥–µ—Ç –ª–∏ —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å API-–∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ?
‚úÖ –î–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ:

–ü–æ—Ç–æ–∫–∏ (fs.createReadStream, pipe()) —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.
–ó–∞–ø—Ä–æ—Å—ã –≤ PostgreSQL (db.query()) –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç Event Loop.
API-–∑–∞–ø—Ä–æ—Å—ã –≤ Express/Nest.js –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
‚ö†Ô∏è –ù–æ –≤–∞–∂–Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –ë–î ‚Äî –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–æ–∏—Ç:

–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —á–∏—Å–ª–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (p-map).
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç–Ω—É—é –≤—Å—Ç–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö (Batch INSERT).
–ñ–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ db.end().
üöÄ –¢–µ–ø–µ—Ä—å —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä —Å–º–æ–∂–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å API-–∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –ª–∞–≥–æ–≤!
